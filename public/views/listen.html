<!DOCTYPE html>

<html>

<head>
	<link rel="stylesheet" href="/vendor/vue-material.css">
	<link rel="stylesheet" href="/styles/listen.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.2/socket.io.min.js"></script>
	<script src="https://unpkg.com/vue/dist/vue.min.js"></script>
	<script src="/vendor/vue-material.js"></script>
</head>
<body>
	<div id="podcast" v-md-theme="'default'">
		<div v-if="audio">
			<div class="md-display-2" id="description" v-if="podcast">{{ podcast.description }}</div>
			<div>
				<md-button class="md-raised" v-on:click="toggle">{{ paused ? 'Play' : 'Pause' }}</md-button>
				<span class="md-display-1">{{ Math.floor(currentTime) }} / {{ Math.floor(duration) }}</span>
			</div>
			<div class="volume-control">
				<label for="volume">Volume</label>
				<input v-model="volume" type="range" name="volume" min="0" max="1" step=".01" value="1">
				{{volume}}
			</div>
		</div>
		<div v-else>
			<span>Waiting for podcast audio...</span>
		</div>
	</div>

	<div id="chat">
		<div id='messages'>
			<p v-for="message in messages">
				<strong>{{ message.author }}: </strong>
				<span>{{ message.content }}</span>
				<span> ({{message.date.getHours()}}:{{message.date.getMinutes()}})</span>
			</p>
		</div>

		<form v-on:submit.prevent>
			<label for="message">Chat: </label>
			<input name="message" type="text"
				v-model.trim="currentMessage"
				v-on:keyup.enter="handleInputKeyup">
		</form>
	</div>

	<script>
		Vue.use(VueMaterial);

		Vue.material.theme.register('default', {
			primary: 'cyan',
			accent: 'pink'
		});

		let nickname = localStorage.getItem('nickname');

		if (!nickname) {
			nickname = prompt('Please enter a nickname');

			localStorage.setItem('nickname', nickname);
		}

		const podcastId = window.location.pathname.substr(8);

		const socketAddr = `${window.location.protocol}//${window.location.hostname}:3001`;
		const socket = io.connect(socketAddr);

		socket.emit('join', {nickname, podcastId});
	</script>
	<script src="/scripts/listen.js"></script>
	<script>
		function Message(author, content, date, podcastId) {
			this.author = author;
			this.content = content;
			this.date = new Date(date);
		}

		const chat = new Vue({
			el: '#chat',
			data: {
				currentMessage: '',
				podcastId: podcastId,
				socket: socket,
				user: nickname,
				messages: []
			},
			created: function() {
				this.socket.on('message', ({author, content, date}) => {
					this.messages.push(new Message(author, content, date));
				})

				this.socket.on('messages', messages => {
					this.messages = messages
						.map(({author, content, date}) => new Message(author, content, date))
						.sort((m1, m2) => m1.date > m2.date);
				})

				this.socket.emit('chat-connect');
			},
			methods: {
				handleInputKeyup: function() {
					if (this.currentMessage !== '') {
						this.submitMessage();
					}
				},
				submitMessage: function(text) {
					const message = {
						author: this.user,
						content: this.currentMessage,
						date: new Date(),
						podcastId: this.podcastId
					}

					this.socket.emit('message', message);

					this.currentMessage = '';
				}
			}
		});
	</script>
</body>

</html>