<!DOCTYPE html>

<html>

<head>
	<link rel="stylesheet" href="/styles/index.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.2/socket.io.min.js"></script>
	<script src="https://unpkg.com/vue/dist/vue.js"></script>
</head>
<body>
	<form action="/podcast/new" v-on:submit.prevent="submit" id="form" method="post">
		<div>
			<label for="name">Url to audio file</label>
			<input v-model="currentUrl" name="url" type="text">
		</div>
		<span v-text="currentUrl"></span>
		<span v-text="urlStatusMessage"></span>
		<div>
			<label for="description">Name or description</label>
			<input v-model="description" name="description" type="text">
		</div>

		<button>Submit</button>
	</form>

	<div id="podcasts">
		<div class="podcast-wrapper" v-for="podcast in podcasts">
			<h3 class="podcast-title">
				<a class="podcast-link" :href="`/listen/${podcast._id}`">{{ podcast.description ? podcast.description : "No description given..." }}</a>
				<button :data-podcast-id="podcast._id" v-on:click="deletePodcast">Remove</button>
			</h3>
			<div class="podcast-address">{{podcast.src}}</div>
		</div>
	</div>

	<script>
		(() => {
			new Vue({
				el: '#form',
				data: {
					currentUrl: null,
					description: null,
					isValidUrl: false
				},
				computed: {
					urlStatusMessage: function() {
						return this.isValidUrl ? 'URL is valid!' : 'Please enter a valid URL.'
					}
				},
				methods: {
					submit: function(event) {
						fetch(this.currentUrl, {mode: 'cors'})
							.then(res => {
								this.isValidUrl = (res.status == 200);

								if (this.isValidUrl && this.description) {
									event.target.submit();
								}
							})
							.catch(err => {
								this.isValidUrl = (err.toString() === 'TypeError: Failed to fetch');

								if (this.isValidUrl && this.description) {
									event.target.submit();
								}
							});
					}
				}
			});

			fetch('/podcasts')
				.then(response => response.json())
				.then(podcasts => {
					const socketAddr = `${window.location.protocol}//${window.location.hostname}:3001`;

					new Vue({
						el: '#podcasts',
						data: {
							podcasts: podcasts,
							socket: io.connect(socketAddr)
						},
						created: function() {
							this.socket.on('podcasts', (podcasts) => this.podcasts = podcasts);
						},
						methods: {
							deletePodcast: function(event) {
								if (confirm(`Are you sure you want to delete the podcast ${this.description}?`)) {
									let podcastId = event.target.dataset.podcastId;

									this.socket.emit('removePodcast', podcastId);
								}
							}
						}
					});
				});

		})();
	</script>
</body>

</html>